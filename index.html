<script>
    const canvas = document.getElementById("signatureCanvas");
    const ctx = canvas.getContext("2d");
    const typedSignatureInput = document.getElementById("typedSignature");
    const drawSignatureButton = document.getElementById("drawButton");
    const typeSignatureButton = document.getElementById("typeButton");
    const uploadSignatureButton = document.getElementById("uploadButton");
    const uploadInput = document.getElementById("uploadSignature");

    let drawing = false;
    let uploadedImage = null;
    let lastPos = { x: 0, y: 0 };

    // High-DPI fix
    function setupCanvasResolution() {
        const ratio = window.devicePixelRatio || 1;
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
    }

    setupCanvasResolution();

    function getMousePos(canvas, event) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: event.clientX - rect.left,
            y: event.clientY - rect.top
        };
    }

    function startDrawing(event) {
        if (!drawSignatureButton.classList.contains('active') || uploadedImage) return;
        drawing = true;
        lastPos = getMousePos(canvas, event);
        ctx.beginPath();
        ctx.moveTo(lastPos.x, lastPos.y);
    }

    function draw(event) {
        if (!drawing || !drawSignatureButton.classList.contains('active') || uploadedImage) return;
        const pos = getMousePos(canvas, event);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#000';
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastPos = pos;
    }

    function stopDrawing() {
        drawing = false;
        ctx.closePath();
    }

    function clearSignature() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        typedSignatureInput.value = '';
        uploadedImage = null;
    }

    function switchSignatureMode(mode) {
        canvas.style.display = mode === 'draw' ? 'block' : 'none';
        typedSignatureInput.style.display = mode === 'type' ? 'block' : 'none';
        uploadInput.style.display = mode === 'upload' ? 'block' : 'none';

        drawSignatureButton.classList.toggle('active', mode === 'draw');
        typeSignatureButton.classList.toggle('active', mode === 'type');
        uploadSignatureButton.classList.toggle('active', mode === 'upload');
    }

    function uploadSignature(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    uploadedImage = img;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(uploadedImage, 0, 0, canvas.width, canvas.height);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("mouseleave", stopDrawing);

    // Set default mode
    switchSignatureMode('draw');
</script>
